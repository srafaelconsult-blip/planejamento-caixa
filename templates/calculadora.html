<script>
    let graficoSaldo = null;
    let graficoReceitasDespesas = null;
    
    async function checkSubscription() {
        try {
            const response = await fetch('/subscription_info');
            const data = await response.json();
            
            if (data.active && data.end_date) {
                const endDate = new Date(data.end_date);
                document.getElementById('subscription-end').textContent = endDate.toLocaleDateString('pt-BR');
                document.getElementById('subscription-info').style.display = 'block';
            } else {
                document.getElementById('subscription-info').style.display = 'none';
                window.location.href = '/payment';
            }
        } catch (error) {
            console.error('Erro ao verificar assinatura:', error);
        }
    }
    
    async function getUserEmail() {
        try {
            const response = await fetch('/user_info');
            const data = await response.json();
            return data.email || 'usuario@exemplo.com';
        } catch (error) {
            console.error('Erro ao obter email do usuario:', error);
            return 'usuario@exemplo.com';
        }
    }
    
    async function logout() {
        try {
            await fetch('/logout');
            window.location.href = '/login';
        } catch (error) {
            console.error('Erro ao fazer logout:', error);
        }
    }
    
    async function calcular() {
        console.log('Função calcular chamada'); // Debug
        
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const errorMessage = document.getElementById('error-message');
        
        loading.style.display = 'block';
        results.style.display = 'none';
        errorMessage.style.display = 'none';
        
        try {
            // Capturar os valores de previsão de vendas para usar na tabela
            const previsaoVendas = [
                parseFloat(document.getElementById('venda_mes1').value) || 0,
                parseFloat(document.getElementById('venda_mes2').value) || 0,
                parseFloat(document.getElementById('venda_mes3').value) || 0,
                parseFloat(document.getElementById('venda_mes4').value) || 0,
                parseFloat(document.getElementById('venda_mes5').value) || 0,
                parseFloat(document.getElementById('venda_mes6').value) || 0
            ];
            
            const dados = {
                previsao_vendas: previsaoVendas,
                contas_receber_anteriores: [
                    parseFloat(document.getElementById('receber_anteriores_mes1').value) || 0,
                    parseFloat(document.getElementById('receber_anteriores_mes2').value) || 0,
                    parseFloat(document.getElementById('receber_anteriores_mes3').value) || 0,
                    parseFloat(document.getElementById('receber_anteriores_mes4').value) || 0,
                    parseFloat(document.getElementById('receber_anteriores_mes5').value) || 0,
                    parseFloat(document.getElementById('receber_anteriores_mes6').value) || 0
                ],
                comissoes_anteriores: [
                    parseFloat(document.getElementById('comissoes_anteriores_mes1').value) || 0,
                    parseFloat(document.getElementById('comissoes_anteriores_mes2').value) || 0,
                    parseFloat(document.getElementById('comissoes_anteriores_mes3').value) || 0,
                    parseFloat(document.getElementById('comissoes_anteriores_mes4').value) || 0,
                    parseFloat(document.getElementById('comissoes_anteriores_mes5').value) || 0,
                    parseFloat(document.getElementById('comissoes_anteriores_mes6').value) || 0
                ],
                contas_pagar_anteriores: [
                    parseFloat(document.getElementById('pagar_anteriores_mes1').value) || 0,
                    parseFloat(document.getElementById('pagar_anteriores_mes2').value) || 0,
                    parseFloat(document.getElementById('pagar_anteriores_mes3').value) || 0,
                    parseFloat(document.getElementById('pagar_anteriores_mes4').value) || 0,
                    parseFloat(document.getElementById('pagar_anteriores_mes5').value) || 0,
                    parseFloat(document.getElementById('pagar_anteriores_mes6').value) || 0
                ],
                desp_fixas_manuais: [
                    parseFloat(document.getElementById('desp_fixas_mes1').value) || 0,
                    parseFloat(document.getElementById('desp_fixas_mes2').value) || 0,
                    parseFloat(document.getElementById('desp_fixas_mes3').value) || 0,
                    parseFloat(document.getElementById('desp_fixas_mes4').value) || 0,
                    parseFloat(document.getElementById('desp_fixas_mes5').value) || 0,
                    parseFloat(document.getElementById('desp_fixas_mes6').value) || 0
                ],
                desp_variaveis_manuais: [
                    parseFloat(document.getElementById('desp_variaveis_m1').value) || 0
                ],
                setup: {
                    vendas_vista: parseFloat(document.getElementById('vendas_vista').value) || 0.3,
                    vendas_parcelamento: parseInt(document.getElementById('vendas_parcelamento').value) || 5,
                    plus_vendas: parseFloat(document.getElementById('plus_vendas').value) || 0,
                    cmv: parseFloat(document.getElementById('cmv').value) || 0.425,
                    percent_compras: parseFloat(document.getElementById('percent_compras').value) || 0.2,
                    compras_vista: parseFloat(document.getElementById('compras_vista').value) || 0.2,
                    compras_parcelamento: parseInt(document.getElementById('compras_parcelamento').value) || 6,
                    comissoes: parseFloat(document.getElementById('comissoes').value) || 0.0761,
                    desp_variaveis_impostos: parseFloat(document.getElementById('desp_variaveis_impostos').value) || 0.085
                }
            };

            console.log('Dados enviados:', dados); // Debug

            const response = await fetch('/calcular', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dados)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Erro ao calcular');
            }
            
            const resultados = await response.json();
            console.log('Resultados recebidos:', resultados); // Debug
            
            // Adicionar a previsão de vendas aos resultados
            resultados.resultados["PREVISÃO DE VENDAS"] = [
                ...previsaoVendas.map(valor => `R$ ${valor.toLocaleString('pt-BR')}`),
                `R$ ${previsaoVendas.reduce((a, b) => a + b, 0).toLocaleString('pt-BR')}`
            ];
            
            exibirIndicadores(resultados.indicadores);
            exibirGraficos(resultados.graficos);
            exibirTabela(resultados.resultados, resultados.meses);
            
            loading.style.display = 'none';
            results.style.display = 'block';
            
        } catch (error) {
            console.error('Erro no cálculo:', error); // Debug
            loading.style.display = 'none';
            errorMessage.textContent = error.message;
            errorMessage.style.display = 'block';
        }
    }
    
    function exibirIndicadores(indicadores) {
        const container = document.getElementById('indicadores');
        container.innerHTML = '';
        
        for (const [nome, valor] of Object.entries(indicadores)) {
            const div = document.createElement('div');
            div.className = 'indicador';
            div.innerHTML = `
                <h3>${nome}</h3>
                <p class="valor">${valor}</p>
            `;
            container.appendChild(div);
        }
    }

    function exibirGraficos(dadosGraficos) {
        const ctxSaldo = document.getElementById('graficoSaldo').getContext('2d');
        if (graficoSaldo) {
            graficoSaldo.destroy();
        }
        graficoSaldo = new Chart(ctxSaldo, {
            type: 'line',
            data: {
                labels: dadosGraficos.meses,
                datasets: [{
                    label: 'Saldo Final de Caixa',
                    data: dadosGraficos.saldo_final_caixa,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        const ctxReceitasDespesas = document.getElementById('graficoReceitasDespesas').getContext('2d');
        if (graficoReceitasDespesas) {
            graficoReceitasDespesas.destroy();
        }
        graficoReceitasDespesas = new Chart(ctxReceitasDespesas, {
            type: 'bar',
            data: {
                labels: dadosGraficos.meses,
                datasets: [
                    {
                        label: 'Receitas',
                        data: dadosGraficos.receitas,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    },
                    {
                        label: 'Despesas',
                        data: dadosGraficos.despesas,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)'
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function exibirTabela(resultados, meses) {
        const container = document.getElementById('tabela-resultados');
        container.innerHTML = '';

        // Ordem fixa das linhas
        const ordemCorreta = [
            "PREVISÃO DE VENDAS",
            "Recebimento de vendas à vista",
            "Contas a receber Parcelado",
            "Contas a receber anteriores",
            "Total de Contas a Receber",
            "",
            "Pagamento de comissões à vista",
            "Comissões parceladas",
            "Comissões a pagar anteriores",
            "Total de Comissões a pagar",
            "",
            "Compras à vista",
            "Fornecedores Parcelados",
            "Fornecedores Anteriores",
            "Total Pagamento de Fornecedores",
            "",
            "Despesas variáveis",
            "Despesas fixas",
            "",
            "SALDO OPERACIONAL",
            "SALDO FINAL DE CAIXA PREVISTO"
        ];

        let tableHTML = '<table><thead><tr><th>Descricao</th>';
        meses.forEach(mes => {
            tableHTML += `<th>${mes}</th>`;
        });
        tableHTML += '</tr></thead><tbody>';

        // Criar a tabela na ordem correta
        ordemCorreta.forEach(descricao => {
            if (descricao === "") {
                tableHTML += '<tr class="empty-row"><td colspan="' + (meses.length + 1) + '"></td></tr>';
            } else if (resultados[descricao]) {
                // Definir classes para linhas em negrito
                let rowClass = '';
                if ([
                    "Total de Contas a Receber",
                    "Total de Comissões a pagar", 
                    "Compras à vista",
                    "Total Pagamento de Fornecedores",
                    "Despesas variáveis",
                    "Despesas fixas",
                    "SALDO OPERACIONAL",
                    "SALDO FINAL DE CAIXA PREVISTO"
                ].includes(descricao)) {
                    rowClass = 'bold-row';
                } else if (descricao === "PREVISÃO DE VENDAS") {
                    rowClass = 'section-header';
                }

                tableHTML += `<tr class="${rowClass}">`;
                tableHTML += `<td>${descricao}</td>`;
                resultados[descricao].forEach(valor => {
                    tableHTML += `<td>${valor}</td>`;
                });
                tableHTML += '</tr>';
            }
        });
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const userEmail = await getUserEmail();
        document.getElementById('user-email').textContent = userEmail;
        checkSubscription();
        
        // Adicionar evento de clique com prevenção padrão
        document.querySelector('.calculate-btn').addEventListener('click', function(e) {
            e.preventDefault();
            calcular();
        });
    });
</script>
