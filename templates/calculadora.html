<script>
    // ... código anterior ...

    function mostrarResultados(dados) {
        document.getElementById('resultados').style.display = 'block';
        
        // Construir tabela de resultados - VERIFICANDO se os dados existem
        const tabelaHTML = `
            <tr><td>Previsão Vendas</td>${addLinhaTabela(dados.previsao_vendas)}</tr>
            <tr><td>Vendas c/ Plus</td>${addLinhaTabela(dados.vendas_escalonadas)}</tr>
            <tr><td>Vendas à Vista</td>${addLinhaTabela(dados.vendas_vista)}</tr>
            <tr><td>Total Recebimentos</td>${addLinhaTabela(dados.total_recebimentos)}</tr>
            <tr><td>Comissões</td>${addLinhaTabela(dados.total_comissoes)}</tr>
            <tr><td>Compras Planejadas</td>${addLinhaTabela(dados.compras_planejadas)}</tr>
            <tr><td>Compras à Vista</td>${addLinhaTabela(dados.compras_vista)}</tr>
            <tr><td>Total Pag. Compras</td>${addLinhaTabela(dados.total_pagamento_compras)}</tr>
            <tr><td>Desp. Variáveis</td>${addLinhaTabela(dados.desp_variaveis)}</tr>
            <tr><td>Desp. Fixas</td>${addLinhaTabela(dados.desp_fixas)}</tr>
            <tr><td>Saldo Operacional</td>${addLinhaTabela(dados.saldo_operacional)}</tr>
            <tr><td>Saldo Final Caixa</td>${addLinhaTabela(dados.saldo_final_caixa)}</tr>
        `;
        
        document.getElementById('tabela-resultados').innerHTML = tabelaHTML;
        
        // Criar gráficos
        criarGraficos(dados);
    }

    function addLinhaTabela(valores) {
        // VERIFICAÇÃO DE SEGURANÇA - se valores é undefined ou não é array
        if (!valores || !Array.isArray(valores)) {
            console.error('Valores inválidos:', valores);
            return '<td>Erro</td><td>Erro</td><td>Erro</td><td>Erro</td><td>Erro</td><td>Erro</td>';
        }
        
        try {
            const total = valores.reduce((sum, val) => sum + val, 0);
            return valores.map(v => `<td>R$ ${v.toFixed(2)}</td>`).join('') + `<td><strong>R$ ${total.toFixed(2)}</strong></td>`;
        } catch (error) {
            console.error('Erro ao calcular total:', error, valores);
            return '<td>Erro</td><td>Erro</td><td>Erro</td><td>Erro</td><td>Erro</td><td>Erro</td>';
        }
    }

    function criarGraficos(dados) {
        // VERIFICAÇÃO DE SEGURANÇA para os gráficos
        if (!dados.saldo_final_caixa || !Array.isArray(dados.saldo_final_caixa)) {
            console.error('Dados inválidos para gráficos:', dados);
            return;
        }

        // Gráfico de evolução do saldo de caixa
        try {
            new Chart(document.getElementById('grafico-caixa'), {
                type: 'line',
                data: {
                    labels: ['Mês 1', 'Mês 2', 'Mês 3', 'Mês 4', 'Mês 5'],
                    datasets: [{
                        label: 'Saldo de Caixa',
                        data: dados.saldo_final_caixa,
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0, 0, 255, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolução do Saldo de Caixa'
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Erro ao criar gráfico de caixa:', error);
        }

        // Gráfico comparativo
        try {
            new Chart(document.getElementById('grafico-comparativo'), {
                type: 'bar',
                data: {
                    labels: ['Mês 1', 'Mês 2', 'Mês 3', 'Mês 4', 'Mês 5'],
                    datasets: [
                        {
                            label: 'Receitas',
                            data: dados.total_recebimentos || [],
                            backgroundColor: 'green'
                        },
                        {
                            label: 'Despesas',
                            data: dados.total_comissoes ? dados.total_comissoes.map((v, i) => 
                                v + dados.total_pagamento_compras[i] + dados.desp_variaveis[i] + dados.desp_fixas[i]
                            ) : [],
                            backgroundColor: 'red'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Receitas vs Despesas'
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Erro ao criar gráfico comparativo:', error);
        }
    }
</script>
